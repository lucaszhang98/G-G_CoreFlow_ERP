# å¤šæ—¶åŒºç³»ç»Ÿè§£å†³æ–¹æ¡ˆï¼ˆä¸­å›½ + ç¾å›½ï¼‰

## ğŸ¯ **æ ¸å¿ƒåŸåˆ™**

### 1. **æ•°æ®å­˜å‚¨å±‚ï¼ˆæ•°æ®åº“ï¼‰**
- âœ… **ç»Ÿä¸€ä½¿ç”¨ UTC**ï¼šæ‰€æœ‰æ—¶é—´æˆ³å­˜å‚¨ä¸º UTC
- âœ… **æ—¥æœŸå­—æ®µ**ï¼šçº¯æ—¥æœŸå­—æ®µï¼ˆ`@db.Date`ï¼‰ä¸åŒ…å«æ—¶åŒºï¼ŒæŒ‰ä¸šåŠ¡æ—¶åŒºå­˜å‚¨

### 2. **ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåç«¯ APIï¼‰**
- âœ… **ç»Ÿä¸€ä½¿ç”¨ä¸šåŠ¡æ—¶åŒº**ï¼šä»“åº“åœ¨ç¾å›½ï¼Œä½¿ç”¨ **PST/PDT (America/Los_Angeles)**
- âœ… **æ‰€æœ‰ä¸šåŠ¡è®¡ç®—**ï¼šåŸºäº PST æ—¶åŒºè¿›è¡Œ
- âœ… **æ—¥æœŸæ¯”è¾ƒå’Œè®¡ç®—**ï¼šä½¿ç”¨ PST æ—¶åŒºçš„æ—¥æœŸå­—ç¬¦ä¸²

### 3. **å±•ç¤ºå±‚ï¼ˆå‰ç«¯ï¼‰**
- âœ… **æ ¹æ®ç”¨æˆ·æ—¶åŒºæ˜¾ç¤º**ï¼šä¸­å›½ç”¨æˆ·çœ‹åˆ°åŒ—äº¬æ—¶é—´ï¼Œç¾å›½ç”¨æˆ·çœ‹åˆ° PST æ—¶é—´
- âœ… **ç”¨æˆ·å¯è®¾ç½®æ—¶åŒºåå¥½**ï¼šå…è®¸ç”¨æˆ·é€‰æ‹©æ˜¾ç¤ºæ—¶åŒº
- âœ… **æ—¥æœŸè¾“å…¥**ï¼šæ ¹æ®ç”¨æˆ·æ—¶åŒºè‡ªåŠ¨è½¬æ¢

---

## ğŸ“‹ **æ–¹æ¡ˆè®¾è®¡**

### **æ–¹æ¡ˆ Aï¼šä¸šåŠ¡æ—¶åŒºå›ºå®šä¸º PSTï¼ˆæ¨èï¼‰**

**é€‚ç”¨åœºæ™¯ï¼š**
- ä»“åº“åœ¨ç¾å›½ï¼Œä¸šåŠ¡é€»è¾‘å¿…é¡»åŸºäºç¾å›½æ—¶é—´
- ä¸­å›½ç”¨æˆ·ä¸»è¦æŸ¥çœ‹æ•°æ®ï¼Œä¸éœ€è¦åŸºäºä¸­å›½æ—¶é—´åšä¸šåŠ¡è®¡ç®—

**å®ç°æ–¹å¼ï¼š**
1. **æ•°æ®åº“å­˜å‚¨**ï¼šUTC æ—¶é—´æˆ³ + PST æ—¥æœŸå­—ç¬¦ä¸²
2. **ä¸šåŠ¡è®¡ç®—**ï¼šç»Ÿä¸€ä½¿ç”¨ PST æ—¶åŒº
3. **å‰ç«¯æ˜¾ç¤º**ï¼šæ ¹æ®ç”¨æˆ·æ—¶åŒºè½¬æ¢æ˜¾ç¤º

**ä¼˜ç‚¹ï¼š**
- ä¸šåŠ¡é€»è¾‘ç»Ÿä¸€ï¼Œä¸ä¼šå› ä¸ºç”¨æˆ·æ—¶åŒºä¸åŒè€Œå‡ºç°æ•°æ®ä¸ä¸€è‡´
- å®ç°ç®€å•ï¼Œåªéœ€è¦åœ¨æ˜¾ç¤ºå±‚åšæ—¶åŒºè½¬æ¢

**ç¼ºç‚¹ï¼š**
- å¦‚æœæœªæ¥éœ€è¦æ”¯æŒå¤šä»“åº“ï¼ˆä¸­å›½ä»“åº“ï¼‰ï¼Œéœ€è¦é‡æ„

---

### **æ–¹æ¡ˆ Bï¼šæ”¯æŒç”¨æˆ·æ—¶åŒºåå¥½**

**é€‚ç”¨åœºæ™¯ï¼š**
- éœ€è¦æ”¯æŒç”¨æˆ·é€‰æ‹©æ˜¾ç¤ºæ—¶åŒº
- æŸäº›ä¸šåŠ¡é€»è¾‘å¯èƒ½éœ€è¦åŸºäºç”¨æˆ·æ—¶åŒº

**å®ç°æ–¹å¼ï¼š**
1. **ç”¨æˆ·è¡¨æ·»åŠ æ—¶åŒºå­—æ®µ**ï¼š`users.timezone` (é»˜è®¤ï¼šæµè§ˆå™¨æ—¶åŒº)
2. **æ•°æ®åº“å­˜å‚¨**ï¼šUTC æ—¶é—´æˆ³
3. **ä¸šåŠ¡è®¡ç®—**ï¼šç»Ÿä¸€ä½¿ç”¨ PST æ—¶åŒºï¼ˆä»“åº“æ—¶åŒºï¼‰
4. **å‰ç«¯æ˜¾ç¤º**ï¼šæ ¹æ®ç”¨æˆ·æ—¶åŒºåå¥½è½¬æ¢

**ä¼˜ç‚¹ï¼š**
- çµæ´»æ€§é«˜ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æ˜¾ç¤ºæ—¶åŒº
- æœªæ¥æ‰©å±•æ€§å¥½

**ç¼ºç‚¹ï¼š**
- éœ€è¦ç»´æŠ¤ç”¨æˆ·æ—¶åŒºåå¥½
- å®ç°ç¨å¤æ‚

---

### **æ–¹æ¡ˆ Cï¼šæ™ºèƒ½æ—¶åŒºæ£€æµ‹**

**é€‚ç”¨åœºæ™¯ï¼š**
- è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ—¶åŒº
- ä¸éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®

**å®ç°æ–¹å¼ï¼š**
1. **å‰ç«¯è‡ªåŠ¨æ£€æµ‹**ï¼šä½¿ç”¨ `Intl.DateTimeFormat().resolvedOptions().timeZone`
2. **æ•°æ®åº“å­˜å‚¨**ï¼šUTC æ—¶é—´æˆ³
3. **ä¸šåŠ¡è®¡ç®—**ï¼šç»Ÿä¸€ä½¿ç”¨ PST æ—¶åŒº
4. **å‰ç«¯æ˜¾ç¤º**ï¼šæ ¹æ®æµè§ˆå™¨æ—¶åŒºè‡ªåŠ¨è½¬æ¢

**ä¼˜ç‚¹ï¼š**
- ç”¨æˆ·ä½“éªŒå¥½ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®
- å®ç°ç®€å•

**ç¼ºç‚¹ï¼š**
- å¦‚æœç”¨æˆ·åœ¨ä¸åŒæ—¶åŒºä½¿ç”¨ï¼Œå¯èƒ½ä¼šæœ‰æ··æ·†

---

## ğŸ¯ **æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆ A + æ–¹æ¡ˆ C ç»„åˆ**

### **æ¶æ„è®¾è®¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯å±‚ï¼ˆæ˜¾ç¤ºï¼‰                        â”‚
â”‚  - ä¸­å›½ç”¨æˆ·ï¼šæ˜¾ç¤ºä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)                       â”‚
â”‚  - ç¾å›½ç”¨æˆ·ï¼šæ˜¾ç¤ºä¸º PST æ—¶é—´ (UTC-8/-7)                  â”‚
â”‚  - è‡ªåŠ¨æ£€æµ‹æµè§ˆå™¨æ—¶åŒºï¼Œæ— éœ€ç”¨æˆ·è®¾ç½®                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰                      â”‚
â”‚  - æ‰€æœ‰ä¸šåŠ¡è®¡ç®—ç»Ÿä¸€ä½¿ç”¨ PST æ—¶åŒº                          â”‚
â”‚  - æ—¥æœŸæ¯”è¾ƒä½¿ç”¨ PST æ—¥æœŸå­—ç¬¦ä¸²                            â”‚
â”‚  - æ—¶é—´æˆ³å­˜å‚¨ä¸º UTC                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®åº“å±‚ï¼ˆå­˜å‚¨ï¼‰                         â”‚
â”‚  - Timestamptz: UTC æ—¶é—´æˆ³                                â”‚
â”‚  - Date: PST æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ **å®ç°ç»†èŠ‚**

### **1. æ—¶åŒºå·¥å…·å‡½æ•°é‡æ„**

```typescript
// web/lib/utils/timezone.ts

/**
 * ä¸šåŠ¡æ—¶åŒºï¼šç¾å›½è¥¿éƒ¨æ—¶é—´ï¼ˆPST/PDTï¼‰
 */
export const BUSINESS_TIMEZONE = 'America/Los_Angeles'

/**
 * è·å–ä¸šåŠ¡æ—¶åŒºï¼ˆPSTï¼‰çš„å½“å‰æ—¥æœŸå­—ç¬¦ä¸²
 */
export function getBusinessDateString(): string {
  const now = new Date()
  return toBusinessDateString(now)
}

/**
 * å°†æ—¥æœŸè½¬æ¢ä¸ºä¸šåŠ¡æ—¶åŒºï¼ˆPSTï¼‰çš„æ—¥æœŸå­—ç¬¦ä¸²
 */
export function toBusinessDateString(date: Date | string): string {
  const d = typeof date === 'string' ? new Date(date) : date
  const pstDateStr = d.toLocaleString('en-US', {
    timeZone: BUSINESS_TIMEZONE,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  })
  const parts = pstDateStr.split('/')
  return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`
}

/**
 * è·å–ä¸šåŠ¡æ—¶åŒºï¼ˆPSTï¼‰çš„æ—¥æœŸï¼Œå¹¶æ·»åŠ æŒ‡å®šå¤©æ•°
 */
export function getBusinessDateWithOffset(days: number): string {
  const today = new Date()
  const targetDate = new Date(today)
  targetDate.setDate(today.getDate() + days)
  return toBusinessDateString(targetDate)
}

/**
 * å°† UTC æ—¶é—´æˆ³è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºçš„æ˜¾ç¤ºå­—ç¬¦ä¸²
 */
export function toUserDateTimeString(
  utcDate: Date | string,
  userTimezone?: string
): string {
  const d = typeof utcDate === 'string' ? new Date(utcDate) : utcDate
  const tz = userTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone
  return d.toLocaleString('zh-CN', {
    timeZone: tz,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
  })
}

/**
 * å°† UTC æ—¶é—´æˆ³è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºçš„æ—¥æœŸå­—ç¬¦ä¸²
 */
export function toUserDateString(
  utcDate: Date | string,
  userTimezone?: string
): string {
  const d = typeof utcDate === 'string' ? new Date(utcDate) : utcDate
  const tz = userTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone
  const dateStr = d.toLocaleString('en-US', {
    timeZone: tz,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  })
  const parts = dateStr.split('/')
  return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`
}
```

### **2. SQL æŸ¥è¯¢ä¿®æ”¹**

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ—¥æœŸå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ
const businessDate = getBusinessDateString()  // "2025-12-24"

await prisma.$queryRaw`
  SELECT * FROM wms.inbound_receipt
  WHERE DATE(planned_unload_at) = ${businessDate}::DATE
`

// âŒ é”™è¯¯ï¼šä½¿ç”¨ Date å¯¹è±¡
const date = new Date()  // æœ¬åœ°æ—¶åŒºçš„ Date å¯¹è±¡
await prisma.$queryRaw`
  WHERE DATE(planned_unload_at) = DATE(${date})  // ä¼šè½¬æ¢ä¸º UTCï¼Œå¯¼è‡´æ—¥æœŸåç§»
`
```

### **3. å‰ç«¯æ˜¾ç¤ºç»„ä»¶**

```typescript
// web/components/timezone-aware-date.tsx

'use client'

import { toUserDateString, toUserDateTimeString } from '@/lib/utils/timezone'

interface TimezoneAwareDateProps {
  date: Date | string
  format?: 'date' | 'datetime'
  userTimezone?: string
}

export function TimezoneAwareDate({
  date,
  format = 'date',
  userTimezone,
}: TimezoneAwareDateProps) {
  const displayString =
    format === 'datetime'
      ? toUserDateTimeString(date, userTimezone)
      : toUserDateString(date, userTimezone)

  return <span>{displayString}</span>
}
```

### **4. API å“åº”æ ¼å¼**

```typescript
// API è¿”å› UTC æ—¶é—´æˆ³
{
  "created_at": "2025-12-11T06:19:02.064Z",  // UTC
  "planned_unload_at": "2025-12-24",  // ä¸šåŠ¡æ—¥æœŸï¼ˆPSTï¼‰
}

// å‰ç«¯æ˜¾ç¤ºæ—¶è½¬æ¢
const displayDate = toUserDateString(data.created_at)  // æ ¹æ®ç”¨æˆ·æ—¶åŒºæ˜¾ç¤º
```

---

## ğŸ“ **å®æ–½æ­¥éª¤**

### **é˜¶æ®µ 1ï¼šä¿®å¤æ ¸å¿ƒé—®é¢˜ï¼ˆç«‹å³ï¼‰**

1. âœ… é‡æ„ `timezone.ts` å·¥å…·å‡½æ•°
2. âœ… ä¿®æ”¹ `inventory-forecast-service.ts` ä½¿ç”¨æ—¥æœŸå­—ç¬¦ä¸²
3. âœ… ä¿®æ”¹æ‰€æœ‰ SQL æŸ¥è¯¢ä½¿ç”¨æ—¥æœŸå­—ç¬¦ä¸²è€Œä¸æ˜¯ Date å¯¹è±¡

### **é˜¶æ®µ 2ï¼šç»Ÿä¸€ä¸šåŠ¡é€»è¾‘ï¼ˆçŸ­æœŸï¼‰**

1. âœ… æ‰€æœ‰ä¸šåŠ¡è®¡ç®—ç»Ÿä¸€ä½¿ç”¨ PST æ—¶åŒº
2. âœ… æ‰€æœ‰æ—¥æœŸæ¯”è¾ƒä½¿ç”¨ PST æ—¥æœŸå­—ç¬¦ä¸²
3. âœ… æ—¶é—´æˆ³ç»Ÿä¸€å­˜å‚¨ä¸º UTC

### **é˜¶æ®µ 3ï¼šå‰ç«¯æ˜¾ç¤ºä¼˜åŒ–ï¼ˆä¸­æœŸï¼‰**

1. âœ… åˆ›å»ºæ—¶åŒºæ„ŸçŸ¥çš„æ—¥æœŸæ˜¾ç¤ºç»„ä»¶
2. âœ… æ‰€æœ‰å‰ç«¯æ—¥æœŸæ˜¾ç¤ºä½¿ç”¨æ–°ç»„ä»¶
3. âœ… è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ—¶åŒºï¼ˆå¯é€‰ï¼šæ·»åŠ ç”¨æˆ·æ—¶åŒºåå¥½è®¾ç½®ï¼‰

---

## ğŸ” **éªŒè¯æ–¹æ³•**

### **1. æµ‹è¯•ä¸šåŠ¡é€»è¾‘ï¼ˆPST æ—¶åŒºï¼‰**

```typescript
// æµ‹è¯•ï¼šåœ¨ PST æ—¶åŒºçš„ 2025-12-24 00:00:00
const businessDate = getBusinessDateString()  // "2025-12-24"

// æŸ¥è¯¢æ•°æ®åº“
const result = await prisma.$queryRaw`
  SELECT COUNT(*) FROM wms.inbound_receipt
  WHERE DATE(planned_unload_at) = ${businessDate}::DATE
`

// åº”è¯¥è¿”å›æ­£ç¡®çš„è®°å½•æ•°ï¼ˆåŸºäº PST æ—¶åŒºï¼‰
```

### **2. æµ‹è¯•å‰ç«¯æ˜¾ç¤ºï¼ˆç”¨æˆ·æ—¶åŒºï¼‰**

```typescript
// ä¸­å›½ç”¨æˆ·ï¼ˆUTC+8ï¼‰
const utcDate = new Date('2025-12-24T00:00:00Z')  // UTC
const displayDate = toUserDateString(utcDate)  // "2025-12-24" (åŒ—äº¬æ—¶é—´)

// ç¾å›½ç”¨æˆ·ï¼ˆPST, UTC-8ï¼‰
const displayDate = toUserDateString(utcDate)  // "2025-12-23" (PST æ—¶é—´)
```

### **3. æµ‹è¯•æ—¶åŒºè½¬æ¢**

```typescript
// åœ¨ä¸åŒæ—¶åŒºçš„æœåŠ¡å™¨/æµè§ˆå™¨ä¸Šæµ‹è¯•
// ç¡®ä¿ä¸šåŠ¡é€»è¾‘å§‹ç»ˆä½¿ç”¨ PST æ—¶åŒº
// ç¡®ä¿å‰ç«¯æ˜¾ç¤ºæ ¹æ®ç”¨æˆ·æ—¶åŒºè½¬æ¢
```

---

## ğŸ¯ **æ€»ç»“**

**æ¨èæ–¹æ¡ˆï¼š**
- âœ… æ•°æ®åº“ï¼šUTC æ—¶é—´æˆ³ + PST æ—¥æœŸå­—ç¬¦ä¸²
- âœ… ä¸šåŠ¡é€»è¾‘ï¼šç»Ÿä¸€ä½¿ç”¨ PST æ—¶åŒº
- âœ… å‰ç«¯æ˜¾ç¤ºï¼šæ ¹æ®ç”¨æˆ·æ—¶åŒºè‡ªåŠ¨è½¬æ¢

**ä¼˜ç‚¹ï¼š**
- ä¸šåŠ¡é€»è¾‘ç»Ÿä¸€ï¼Œä¸ä¼šå› ä¸ºç”¨æˆ·æ—¶åŒºä¸åŒè€Œå‡ºç°æ•°æ®ä¸ä¸€è‡´
- ç”¨æˆ·ä½“éªŒå¥½ï¼Œè‡ªåŠ¨æ˜¾ç¤ºç”¨æˆ·æœ¬åœ°æ—¶åŒº
- å®ç°ç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦åœ¨æ˜¾ç¤ºå±‚åšæ—¶åŒºè½¬æ¢

**æ³¨æ„äº‹é¡¹ï¼š**
- æ‰€æœ‰æ—¥æœŸæ¯”è¾ƒå¿…é¡»ä½¿ç”¨ PST æ—¥æœŸå­—ç¬¦ä¸²
- æ‰€æœ‰æ—¶é—´æˆ³å­˜å‚¨ä¸º UTC
- å‰ç«¯æ˜¾ç¤ºæ—¶ç»Ÿä¸€ä½¿ç”¨æ—¶åŒºè½¬æ¢å‡½æ•°

