# 库存管理字段映射文档

本文档详细说明库存管理（inventory_lots）中每个字段对应的 Neon DB 数据库字段。

## 数据库表：`wms.inventory_lots`

### 主表字段（直接存储在 inventory_lots 表中）

| 前端字段名 | 显示标签 | 数据库字段名 | 数据类型 | 说明 |
|-----------|---------|-------------|---------|------|
| `inventory_lot_id` | ID | `inventory_lot_id` | `BigInt` | 主键，自动递增 |
| `warehouse_id` | 仓库 | `warehouse_id` | `BigInt` | 外键，关联 `warehouses.warehouse_id` |
| `storage_location_code` | 位置 | `storage_location_code` | `String?` (VarChar(100)) | 存储位置代码 |
| `status` | 状态 | `status` | `String?` (VarChar(50)) | 状态：available, allocated, shipped, reserved |
| `order_id` | 订单ID | `order_id` | `BigInt` | 外键，关联 `orders.order_id` |
| `order_detail_id` | 订单明细ID | `order_detail_id` | `BigInt` | 外键，关联 `order_detail.id` |
| `inbound_receipt_id` | 拆柜规划ID | `inbound_receipt_id` | `BigInt?` | 外键，关联 `inbound_receipt.inbound_receipt_id` |
| `lot_number` | 批次号 | `lot_number` | `String?` (VarChar(50)) | 批次编号 |
| `received_date` | 收货日期 | `received_date` | `DateTime?` (Date) | 收货日期 |
| `pallet_count` | 实际板数 | `pallet_count` | `Int` | 默认值：1 |
| `remaining_pallet_count` | 剩余板数 | `remaining_pallet_count` | `Int?` | 默认值：0 |
| `unbooked_pallet_count` | 未约板数 | `unbooked_pallet_count` | `Int?` | 默认值：0 |
| `unload_transfer_notes` | 拆柜/转仓 | `unload_transfer_notes` | `String?` | 拆柜/转仓备注 |
| `delivery_progress` | 送货进度 | `delivery_progress` | `Decimal?` (Decimal(5, 2)) | 送货进度（0-100） |
| `notes` | 备注 | `notes` | `String?` | 备注（注意：API 注释说此字段在数据库中不存在，但 schema 中有定义） |
| `created_at` | 创建时间 | `created_at` | `DateTime` (Timestamptz(6)) | 创建时间，默认 now() |
| `updated_at` | 更新时间 | `updated_at` | `DateTime` (Timestamptz(6)) | 更新时间，默认 now() |
| `created_by` | 创建人ID | `created_by` | `BigInt?` | 外键，关联 `users.id` |
| `updated_by` | 更新人ID | `updated_by` | `BigInt?` | 外键，关联 `users.id` |

### 关联字段（从关联表获取，计算字段）

| 前端字段名 | 显示标签 | 数据来源 | 说明 |
|-----------|---------|---------|------|
| `customer_name` | 客户名称 | `orders.customers.name` | 从订单关联的客户表获取客户名称 |
| `container_number` | 柜号 | `orders.order_number` | 使用订单号作为柜号显示 |
| `planned_unload_at` | 预计拆柜日期 | `inbound_receipt.planned_unload_at` | 从入库管理（拆柜规划）表获取预计拆柜日期 |
| `delivery_location` | 仓点 | `order_detail.delivery_location` → `locations.location_code` | 从订单明细获取 delivery_location（存储的是 location_id），然后查询 locations 表转换为 location_code |
| `delivery_nature` | 送仓性质 | `order_detail.delivery_nature` | 从订单明细获取送仓性质 |
| `warehouse_name` | 仓库名称 | `warehouses.name` | 从仓库表获取仓库名称 |

### 特殊说明

1. **`delivery_progress` 字段优先级**：
   - 优先使用 `inventory_lots.delivery_progress`
   - 如果为空，则使用 `inbound_receipt.delivery_progress`

2. **`delivery_location` 字段转换**：
   - `order_detail.delivery_location` 存储的是 `location_id`（字符串形式）
   - API 会查询 `locations` 表，将 `location_id` 转换为 `location_code` 显示

3. **`notes` 字段**：
   - 在 Prisma schema 中定义存在
   - 但 API 代码中有注释说"notes 字段在数据库中不存在"
   - 实际使用时需要确认数据库表结构

4. **查询条件**：
   - 只显示已入库的数据：`storage_location_code` 不为空
   - `pallet_count > 0`（板数必须大于0）
   - `inbound_receipt.status = 'received'`（关联的入库管理状态为已收货）

### 关联表结构

#### orders 表（通过 order_id 关联）
- `order_id` (BigInt)
- `order_number` (String) → 用作 `container_number`
- `order_date` (DateTime)
- `customers` (关联表) → `name` 用作 `customer_name`

#### order_detail 表（通过 order_detail_id 关联）
- `id` (BigInt)
- `quantity` (Int)
- `volume` (Decimal)
- `estimated_pallets` (Int)
- `delivery_nature` (String) → 用作 `delivery_nature`
- `delivery_location` (String) → 存储 location_id，转换为 location_code 显示

#### inbound_receipt 表（通过 inbound_receipt_id 关联）
- `inbound_receipt_id` (BigInt)
- `planned_unload_at` (DateTime) → 用作 `planned_unload_at`
- `delivery_progress` (Decimal) → 备用，当 inventory_lots.delivery_progress 为空时使用

#### warehouses 表（通过 warehouse_id 关联）
- `warehouse_id` (BigInt)
- `name` (String) → 用作 `warehouse_name`
- `warehouse_code` (String)

#### locations 表（通过 order_detail.delivery_location 关联）
- `location_id` (BigInt)
- `location_code` (String) → 用于显示 `delivery_location`

## 索引

数据库表包含以下索引：
- `idx_inventory_lots_inbound_receipt_id` - 在 `inbound_receipt_id` 上
- `idx_inventory_lots_order_detail_status` - 在 `order_detail_id` 和 `status` 上（复合索引）
- `idx_inventory_lots_status` - 在 `status` 上

## 外键约束

- `order_id` → `orders.order_id` (CASCADE DELETE)
- `order_detail_id` → `order_detail.id` (CASCADE DELETE)
- `warehouse_id` → `warehouses.warehouse_id` (NO ACTION)
- `inbound_receipt_id` → `inbound_receipt.inbound_receipt_id` (NO ACTION)
- `created_by` → `users.id` (NO ACTION)
- `updated_by` → `users.id` (NO ACTION)

