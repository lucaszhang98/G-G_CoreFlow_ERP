# 订单管理 (orders) 字段映射文档

## 数据库字段 (Neon DB) → 前端显示字段

### 基础字段

| 数据库字段 | 类型 | 前端字段 | 前端标签 | 是否显示 | 说明 |
|-----------|------|---------|---------|---------|------|
| `order_id` | BigInt | `order_id` | 订单ID | ❌ 隐藏 | 主键，由数据库自动生成 |
| `order_number` | String(50) | `order_number` | 订单号 | ✅ 显示 | **直接映射**：数据库字段名 = 前端字段名，唯一标识（如：EGSU9530570），可搜索、可排序 |
| `customer_id` | BigInt? | `customer` | 客户 | ✅ 显示 | 关联 customers 表，显示客户名称 |
| `user_id` | BigInt? | `user_id` | 负责人 | ✅ 显示 | 关联 users 表，显示负责人全名 |
| `order_date` | Date | `order_date` | 订单日期 | ✅ 显示 | 可排序、可筛选 |
| `status` | String(20)? | `status` | 状态 | ✅ 显示 | 可排序、可筛选，支持：pending/confirmed/shipped/delivered/cancelled/archived/direct_delivery/unload |
| `total_amount` | Decimal(12,2) | `total_amount` | 订单金额 | ✅ 显示 | 可排序、可筛选 |
| `discount_amount` | Decimal(12,2)? | `discount_amount` | 折扣金额 | ✅ 显示 | 默认值 0 |
| `tax_amount` | Decimal(12,2)? | `tax_amount` | 税费 | ✅ 显示 | 默认值 0 |
| `final_amount` | Decimal(12,2) | `final_amount` | 最终金额 | ✅ 显示 | 可排序、可筛选 |
| `notes` | String? | `notes` | 备注 | ✅ 显示 | 文本域，可编辑 |

### 日期字段

| 数据库字段 | 类型 | 前端字段 | 前端标签 | 是否显示 | 说明 |
|-----------|------|---------|---------|---------|------|
| `eta_date` | Date? | `eta_date` | ETA日期 | ✅ 显示 | 可筛选（日期范围） |
| `lfd_date` | Date? | `lfd_date` | LFD日期 | ✅ 显示 | |
| `pickup_date` | Date? | `pickup_date` | 提货日期 | ✅ 显示 | |
| `ready_date` | Date? | `ready_date` | 就绪日期 | ✅ 显示 | |
| `return_deadline` | Date? | `return_deadline` | 归还截止日期 | ✅ 显示 | |
| `appointment_time` | Timestamptz(6)? | `appointment_time` | 预约时间 | ❌ 隐藏 | |

### 货柜相关字段

| 数据库字段 | 类型 | 前端字段 | 前端标签 | 是否显示 | 说明 |
|-----------|------|---------|---------|---------|------|
| `container_type` | String(50)? | `container_type` | 货柜类型 | ✅ 显示 | |
| `container_volume` | Decimal(12,2)? | `container_volume` | 整柜体积 | ✅ 显示 | **计算字段**，从 `order_detail.volume` 总和自动计算，显示格式：`{value} CBM` |
| ~~`container_number`~~ | ~~String(100)?~~ | - | - | ❌ **已删除** | **数据库中不存在此字段** |

### 运输相关字段

| 数据库字段 | 类型 | 前端字段 | 前端标签 | 是否显示 | 说明 |
|-----------|------|---------|---------|---------|------|
| `mbl_number` | String(100)? | `mbl_number` | MBL号码 | ✅ 显示 | 可搜索 |
| `do_issued` | Boolean? | `do_issued` | DO已签发 | ✅ 显示 | 默认值 false |
| `carrier_id` | BigInt? | `carrier` | 承运公司 | ✅ 显示 | 关联 carriers 表，显示承运公司名称 |
| `port_location` | String(200)? | `port_location` | 码头/查验站 | ❌ 隐藏 | |
| `operation_mode` | String(50)? | `operation_mode` | 操作方式 | ❌ 隐藏 | |
| `delivery_location` | String(200)? | `delivery_location` | 送货地 | ❌ 隐藏 | |
| `warehouse_account` | String(100)? | `warehouse_account` | 仓库账户 | ❌ 隐藏 | |

### 审计字段

| 数据库字段 | 类型 | 前端字段 | 前端标签 | 是否显示 | 说明 |
|-----------|------|---------|---------|---------|------|
| `created_at` | Timestamptz(6)? | `created_at` | 创建时间 | ❌ 隐藏 | 系统自动维护，可排序 |
| `updated_at` | Timestamptz(6)? | `updated_at` | 更新时间 | ❌ 隐藏 | 系统自动维护，可排序 |
| `created_by` | BigInt? | `created_by` | 创建人ID | ❌ 隐藏 | 系统自动维护 |
| `updated_by` | BigInt? | `updated_by` | 更新人ID | ❌ 隐藏 | 系统自动维护 |

### 关联数据（通过 include 查询）

| 关联关系 | 数据库表 | 前端字段 | 前端标签 | 查询字段 |
|---------|---------|---------|---------|---------|
| `customers` | `customers` | `customer` | 客户 | `id`, `code`, `name`, `company_name` |
| `carriers` | `carriers` | `carrier` | 承运公司 | `carrier_id`, `name`, `carrier_code` |
| `users_orders_user_idTousers` | `users` | `user_id` | 负责人 | `id`, `full_name` |
| `order_detail` | `order_detail` | `order_detail` | 仓点明细 | `id`, `volume` (用于计算 `container_volume`) |

## 重要说明

### 1. container_volume 计算逻辑

- **计算方式**：`container_volume = SUM(order_detail.volume)`
- **更新时机**：
  - 创建订单时：`container_volume = 0`
  - 创建明细时：重新计算并更新
  - 更新明细时：重新计算并更新
  - 删除明细时：重新计算并更新
- **显示格式**：`{value} CBM`（例如：`1,234.56 CBM`）

### 2. 字段查询方式

- **使用 `include`**：查询关联数据（customers, carriers, users, order_detail）
- **不使用 `select`**：查询所有 orders 表的字段（除了关联数据）
- **自动序列化**：BigInt 类型自动转换为字符串

### 3. 已删除的字段

- **`container_number`**：已从 schema.prisma 中删除，数据库中不存在此字段
- **`weight`**：已从 schema.prisma 中删除，数据库中不存在此字段

### 4. 列表显示字段（默认列）

```typescript
columns: [
  'order_number',      // 订单号
  'customer',         // 客户
  'user_id',          // 负责人
  'order_date',       // 订单日期
  'status',           // 状态
  'total_amount',     // 订单金额
  'discount_amount',  // 折扣金额
  'tax_amount',       // 税费
  'final_amount',     // 最终金额
  'container_type',   // 货柜类型
  'container_volume', // 整柜体积
  'eta_date',         // ETA日期
  'lfd_date',         // LFD日期
  'pickup_date',      // 提货日期
  'ready_date',       // 就绪日期
  'return_deadline',  // 归还截止日期
  'mbl_number',      // MBL号码
  'do_issued',        // DO已签发
  'notes'             // 备注
]
```

### 5. 可搜索字段

- `order_number`：订单号
- `mbl_number`：MBL号码

### 6. 可筛选字段

- `status`：状态（下拉选择）
- `order_date`：订单日期（日期范围）
- `eta_date`：ETA日期（日期范围）

### 7. 可排序字段

- `order_date`（默认降序）
- `status`
- `total_amount`
- `final_amount`
- `created_at`
- `updated_at`

## API 路径

- **列表查询**：`GET /api/orders`
- **详情查询**：`GET /api/orders/[id]`
- **创建订单**：`POST /api/orders`
- **更新订单**：`PUT /api/orders/[id]`
- **删除订单**：`DELETE /api/orders/[id]`

## 配置文件位置

- **字段配置**：`web/lib/crud/configs/orders.ts`
- **API Handler**：`web/lib/crud/api-handler.ts`
- **Schema 定义**：`web/prisma/schema.prisma`

